# 《MongoDB权威指南》笔记

## 第1章 简介

* Mongo不具备关系型数据库的所有功能，比如联接（join）等，主要是为了提高扩展性，这些不方便在分布式系统上实现。

## 第2章 入门

* 文档是MongoDB中数据的基本单元，类似于关系数据库管理系统中的行（但是比行复杂很多）

* 集合可以被看成没有模式的表

* MongoDB的单个实例可以容纳多个独立的数据库，每一个都有自己的集合和权限。

* MongoDB自带JavaScript Shell，这个工具对于管理MongoDB实例和操作数据作用非常大。

* 每一个文档都有一个特殊的键 `_id` ，它在文档所属的集合中是唯一的。

### 2.1 文档

* 文档中的键值对是有序的。

### 2.2 集合

* 集合名不能是空字符串""， 不能含有 \0（空字符）。

* 集合名不能以"system."开头，这是为系统集合保留的前缀。
  
* 用户创建的集合名字不能含有保留字符$，除非要访问系统创建的集合，否则不要在名字里出现$。

### 2.3 数据库

* 数据库名不能含有 `" "（空格）`、`.` 、 `$`、 `/` 、 `\` 、`\0（空字符）`，并且应全部小写，最多64字节。

* 有一些数据库名是保留的，可以直接访问这些具有特殊作用的数据库。

* admin是“root”数据库，要是将一个用户添加到这个数据库，这个用户自动继承数据库所有权限，一些特殊的服务端命令也只能从这个数据库运行，比如列出所有数据库或者关闭服务器。

* local：这个数据永远不会被复制，用来存储限于本地单台服务器的人以及和。

* config：当mongo用于分片设置时，config数据库在内部使用，用于保存分片的相关信息。

### 2.4 启动MongoDB

* MongoDB一般作为网络服务来运行，客户端可以连接到服务器并执行操作，要启动该服务器，需要运行mongod可执行文件。

* 在没有设置的情况下，默认数据目录是`/data/db`，默认端口是`27017`。

### 2.5 MongoDB Shell

* 可以运行 mongo 启动shell连接MongoDB进行交互。

* shell开启的时候会连接到MongoDB的 `test` 数据库，并将这个数据库赋值给全局变量 `db`。

* shell还有些非JavaScript的语法的拓展，这是为了方便习惯SQL shell的用户添加的，虽然没有额外的功能，但是是很好的语法糖。

* `insert` 函数用于添加文档，加入的文档都会自动添加 `_id` 键。
  
* `find`函数会返回集合里面所有文档，如果只想查看一个，可以使用 `findOne`

* 使用 `update` 函数接受至少两个参数，一个是要更新文档的限定条件，第二个是新的文档。

* `remove` 用于从数据库中永久性删除文档，在不使用参数调用的情况下会删除集合内所有文档。

### 2.6 数据类型

* `ObjectId` 是 `_id` 的默认类型，是用 **时间戳+机器+PID+计数器** 拼接的。如果插入文档的时候没有`_id`，系统会自动创建一个，但通常由客户端完成，以减少服务器负担。此外也不需要另外查询ObjectId，可以由驱动程序直接返回。

## 第3章 创建、更新及删除文档

### 3.1 插入并保存文档

* 可以发送一个文档的数组给mongoDB进行批量插入，这样只有一个TCP请求，可以有效提高效率

* MongoDB在插入时不执行代码，因此不怕注入攻击

### 3.3 更新文档

* 更新操作是原子的，如果两个更新同时发生，会根据到达服务器顺序依次执行。

* 通常文档只有一部分要更新，利用原子的更新修改器，可以使得这部分更新更为高效，例如可以使用 `$inc` 修改器增加值。
  ```
  db.analytics.update({"url" : "www.example.com"}, {"$inc" : {"pageviews" : 1}})
  // 增加pageviews的值
  ```

* `$set` 修改器：指定一个键的值，如果这个键不存在，则创建它

* `$unset` 可以将键完全删除

* `$inc` 只能用于整数、长整数或双精度浮点数，要是在其他类型上面会操作失败。

* `$push` 会向已有的数组末尾加入一个元素，要是没有就会创建一个新的数组

* `$ne` 可以用来检查一个值是否不在数组里

* `addToSet` 可以用来往数组添加时避免重复

* 将 `$addToSet` 和 `$each` 组合起来，可以添加多个不同的值
  ```
  do.users.update({"_id": ObjectId("xxxxxxxxxxxxxxxxx)},
  {"$addToSet": {"emails" : {"$each":["joe@php.net", "joe@example.com"]}}})
  ```

* `$pull` 可以将匹配内容全部从数组中删除

* `upsert` 是一种特殊的更新，要是没有文档符合更新条件，就会以这个条件和更新文档为基础创建一个新的文档。